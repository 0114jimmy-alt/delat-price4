<script>
// ============================
// å…¨å±€è®Šæ•¸å’Œåˆå§‹åŒ–
// ============================
let selectedService = null;
let currentOrderStep = 1;
let orders = JSON.parse(localStorage.getItem('delta_orders') || '[]');
let adminPassword = localStorage.getItem('admin_password') || 'delta123';

// DOM åŠ è¼‰å®Œæˆ
document.addEventListener('DOMContentLoaded', function() {
    // åˆå§‹åŒ–å°èˆªé¸å–®
    initNavigation();
    
    // åˆå§‹åŒ–ç®¡ç†å¾Œå°çµ±è¨ˆ
    updateOrderStats();
    
    // é¡¯ç¤ºé¦–é 
    showTab('home');
    
    // æª¢æŸ¥æ˜¯å¦æœ‰æ–°è¨‚å–®é€šçŸ¥
    checkForNewOrders();
});

// ============================
// å°èˆªå’Œåˆ†é åŠŸèƒ½
// ============================
function initNavigation() {
    const menuToggle = document.getElementById('menuToggle');
    const navLinks = document.getElementById('navLinks');
    
    if (menuToggle && navLinks) {
        menuToggle.addEventListener('click', function() {
            navLinks.classList.toggle('active');
        });
    }
}

function showTab(tabId) {
    // éš±è—æ‰€æœ‰åˆ†é å…§å®¹
    const tabContents = document.querySelectorAll('.tab-content');
    tabContents.forEach(tab => {
        tab.classList.remove('active');
    });
    
    // æ›´æ–°å°èˆªé€£çµç‹€æ…‹
    const navLinks = document.querySelectorAll('.nav-link');
    navLinks.forEach(link => {
        link.classList.remove('active');
    });
    
    // é¡¯ç¤ºé¸ä¸­çš„åˆ†é 
    const selectedTab = document.getElementById(tabId);
    if (selectedTab) {
        selectedTab.classList.add('active');
        
        // è¨­ç½®å°æ‡‰çš„å°èˆªé€£çµç‚ºæ´»å‹•ç‹€æ…‹
        const correspondingLink = document.querySelector(`.nav-link[onclick*="${tabId}"]`);
        if (correspondingLink) {
            correspondingLink.classList.add('active');
        }
    }
    
    // å¦‚æœé¡¯ç¤ºä»˜æ¬¾é é¢ï¼Œåˆå§‹åŒ–ä»˜æ¬¾æ­¥é©Ÿ
    if (tabId === 'payment') {
        initPaymentSteps();
    }
    
    // æ‰‹æ©Ÿç‰ˆé—œé–‰é¸å–®
    const navLinksMobile = document.getElementById('navLinks');
    if (navLinksMobile && navLinksMobile.classList.contains('active')) {
        navLinksMobile.classList.remove('active');
    }
}

// ============================
// æœå‹™é ç´„åŠŸèƒ½
// ============================
function bookService(name, price, description) {
    selectedService = {
        name: name,
        price: parseInt(price),
        description: description,
        date: new Date().toISOString()
    };
    
    // æ›´æ–°å·²é¸æ“‡æœå‹™é¡¯ç¤º
    updateSelectedServiceDisplay();
    
    // è·³è½‰åˆ°ä»˜æ¬¾é é¢
    showTab('payment');
    
    // æ»¾å‹•åˆ°é ‚éƒ¨
    window.scrollTo(0, 0);
}

function updateSelectedServiceDisplay() {
    if (!selectedService) return;
    
    const displayDiv = document.querySelector('.selected-service-display');
    const titleDiv = document.querySelector('.selected-service-title');
    const detailsDiv = document.querySelector('.selected-service-details');
    
    if (displayDiv && titleDiv && detailsDiv) {
        // æ›´æ–°æœå‹™è³‡è¨Š
        titleDiv.innerHTML = `<span>âœ“</span> ${selectedService.name}`;
        detailsDiv.innerHTML = `
            <div class="service-info">
                <div style="color: #8a9ba8; font-size: 1rem;">${selectedService.description}</div>
                <div style="margin-top: 5px; color: #ffcc00;">
                    é ç´„æ™‚é–“: ${new Date(selectedService.date).toLocaleString('zh-TW')}
                </div>
            </div>
            <div class="service-price">${selectedService.price.toLocaleString()} TWD</div>
            <button class="change-service-btn" onclick="changeService()">æ›´æ›æœå‹™</button>
        `;
        
        // é¡¯ç¤ºå€åŸŸ
        displayDiv.classList.add('active');
        
        // æ›´æ–°è¨‚å–®æ‘˜è¦
        updateOrderSummary();
    }
}

function changeService() {
    // è¿”å›æœå‹™é¸æ“‡é é¢
    showTab('home');
    
    // ç§»é™¤å·²é¸æ“‡æœå‹™é¡¯ç¤º
    const displayDiv = document.querySelector('.selected-service-display');
    if (displayDiv) {
        displayDiv.classList.remove('active');
    }
    
    selectedService = null;
}

function updateOrderSummary() {
    if (!selectedService) return;
    
    const orderSummary = document.querySelector('.order-summary');
    if (orderSummary) {
        const subtotal = selectedService.price;
        const serviceFee = Math.floor(subtotal * 0.05); // 5% æœå‹™è²»
        const total = subtotal + serviceFee;
        
        orderSummary.innerHTML = `
            <div class="order-item">
                <span>${selectedService.name}</span>
                <span>${subtotal.toLocaleString()} TWD</span>
            </div>
            <div class="order-item">
                <span>å¹³å°æœå‹™è²» (5%)</span>
                <span>${serviceFee.toLocaleString()} TWD</span>
            </div>
            <div class="order-total">
                <span>ç¸½è¨ˆ</span>
                <span>${total.toLocaleString()} TWD</span>
            </div>
        `;
    }
}

// ============================
// ä»˜æ¬¾æµç¨‹åŠŸèƒ½
// ============================
function initPaymentSteps() {
    currentOrderStep = 1;
    updatePaymentSteps();
}

function updatePaymentSteps() {
    const steps = document.querySelectorAll('.step');
    steps.forEach((step, index) => {
        step.classList.remove('active', 'completed');
        
        if (index + 1 < currentOrderStep) {
            step.classList.add('completed');
        } else if (index + 1 === currentOrderStep) {
            step.classList.add('active');
        }
    });
}

function nextStep() {
    if (currentOrderStep < 3) {
        currentOrderStep++;
        updatePaymentSteps();
        scrollToCurrentStep();
    }
}

function prevStep() {
    if (currentOrderStep > 1) {
        currentOrderStep--;
        updatePaymentSteps();
        scrollToCurrentStep();
    }
}

function scrollToCurrentStep() {
    const currentStepElement = document.querySelector(`.step:nth-child(${currentOrderStep})`);
    if (currentStepElement) {
        currentStepElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
}

// ä»˜æ¬¾æ–¹å¼é¸æ“‡
let selectedPaymentMethod = null;

function selectPaymentMethod(method) {
    selectedPaymentMethod = method;
    
    // æ›´æ–°æ‰€æœ‰ä»˜æ¬¾æ–¹å¼çš„é¸æ“‡ç‹€æ…‹
    const paymentMethods = document.querySelectorAll('.payment-method');
    paymentMethods.forEach(pm => {
        pm.classList.remove('selected');
    });
    
    // æ¨™è¨˜é¸ä¸­çš„ä»˜æ¬¾æ–¹å¼
    const selectedElement = document.querySelector(`[onclick*="${method}"]`);
    if (selectedElement) {
        selectedElement.parentElement.classList.add('selected');
    }
}

// ============================
// è¨‚å–®æäº¤åŠŸèƒ½
// ============================
function submitOrder() {
    // é©—è­‰è¡¨å–®
    if (!validateOrderForm()) {
        return;
    }
    
    // ç”Ÿæˆè¨‚å–®ç·¨è™Ÿ
    const orderId = 'DELTA-' + Date.now().toString().slice(-8) + Math.random().toString(36).substr(2, 4).toUpperCase();
    
    // æ”¶é›†è¨‚å–®è³‡è¨Š
    const orderData = {
        id: orderId,
        service: selectedService,
        customer: {
            name: document.getElementById('customerName').value,
            contact: document.getElementById('customerContact').value,
            gameId: document.getElementById('gameId').value,
            notes: document.getElementById('orderNotes').value
        },
        payment: {
            method: selectedPaymentMethod,
            status: 'pending'
        },
        status: 'pending',
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString(),
        assignedTo: null,
        notes: []
    };
    
    // å„²å­˜è¨‚å–®
    saveOrder(orderData);
    
    // é¡¯ç¤ºç¢ºèªé é¢
    showConfirmation(orderId);
    
    // ç™¼é€æ–°è¨‚å–®é€šçŸ¥
    sendNewOrderNotification(orderData);
}

function validateOrderForm() {
    if (!selectedService) {
        alert('è«‹å…ˆé¸æ“‡æœå‹™é …ç›®');
        return false;
    }
    
    if (!selectedPaymentMethod) {
        alert('è«‹é¸æ“‡ä»˜æ¬¾æ–¹å¼');
        return false;
    }
    
    const name = document.getElementById('customerName').value.trim();
    const contact = document.getElementById('customerContact').value.trim();
    const gameId = document.getElementById('gameId').value.trim();
    
    if (!name) {
        alert('è«‹è¼¸å…¥æ‚¨çš„å§“å');
        return false;
    }
    
    if (!contact) {
        alert('è«‹è¼¸å…¥è¯çµ¡æ–¹å¼');
        return false;
    }
    
    if (!gameId) {
        alert('è«‹è¼¸å…¥éŠæˆ²ID');
        return false;
    }
    
    return true;
}

function saveOrder(orderData) {
    orders.push(orderData);
    localStorage.setItem('delta_orders', JSON.stringify(orders));
    
    // æ›´æ–°çµ±è¨ˆ
    updateOrderStats();
}

function showConfirmation(orderId) {
    const paymentSection = document.querySelector('.payment-section');
    if (paymentSection) {
        paymentSection.innerHTML = `
            <div class="confirmation-box">
                <div class="confirmation-icon">âœ“</div>
                <h2 class="confirmation-title">è¨‚å–®æäº¤æˆåŠŸï¼</h2>
                <p class="confirmation-text">
                    æ‚¨çš„è¨‚å–®å·²æˆåŠŸæäº¤ï¼Œæˆ‘å€‘çš„åœ˜éšŠå°‡åœ¨15åˆ†é˜å…§èˆ‡æ‚¨è¯ç¹«ã€‚<br>
                    è«‹ä¿æŒè¯çµ¡æ–¹å¼æš¢é€šã€‚
                </p>
                <div class="order-id">è¨‚å–®ç·¨è™Ÿ: ${orderId}</div>
                <p style="color: #8a9ba8; margin-bottom: 30px;">
                    è¨‚å–®è©³ç´°è³‡è¨Šå·²ç™¼é€è‡³æ‚¨çš„è¯çµ¡æ–¹å¼ï¼Œè«‹æ³¨æ„æŸ¥æ”¶ã€‚
                </p>
                <div class="btn-group">
                    <button class="btn" onclick="showTab('home')">è¿”å›é¦–é </button>
                    <button class="btn btn-success" onclick="createNewOrder()">å»ºç«‹æ–°è¨‚å–®</button>
                </div>
            </div>
        `;
    }
}

function createNewOrder() {
    // é‡ç½®è¡¨å–®
    selectedService = null;
    selectedPaymentMethod = null;
    currentOrderStep = 1;
    
    // æ¸…é™¤è¡¨å–®è³‡æ–™
    const formInputs = document.querySelectorAll('.form-input, .form-select, .form-textarea');
    formInputs.forEach(input => {
        input.value = '';
    });
    
    // é‡ç½®ä»˜æ¬¾æ­¥é©Ÿ
    initPaymentSteps();
    
    // ç§»é™¤å·²é¸æ“‡æœå‹™é¡¯ç¤º
    const displayDiv = document.querySelector('.selected-service-display');
    if (displayDiv) {
        displayDiv.classList.remove('active');
    }
    
    // é‡ç½®ä»˜æ¬¾æ–¹å¼é¸æ“‡
    const paymentMethods = document.querySelectorAll('.payment-method');
    paymentMethods.forEach(pm => {
        pm.classList.remove('selected');
    });
    
    // é‡æ–°åŠ è¼‰ä»˜æ¬¾é é¢
    showTab('payment');
}

// ============================
// ç®¡ç†å¾Œå°åŠŸèƒ½
// ============================
function openAdminPanel() {
    const adminPanel = document.getElementById('adminPanel');
    if (adminPanel) {
        adminPanel.classList.add('active');
        document.body.style.overflow = 'hidden';
        
        // é‡ç½®ç™»å…¥é¢æ¿
        document.getElementById('adminLogin').style.display = 'block';
        document.getElementById('ordersPanel').style.display = 'none';
        document.getElementById('syncPanel').style.display = 'none';
        
        // æ¸…é™¤å¯†ç¢¼è¼¸å…¥
        document.getElementById('adminPassword').value = '';
    }
}

function closeAdminPanel() {
    const adminPanel = document.getElementById('adminPanel');
    if (adminPanel) {
        adminPanel.classList.remove('active');
        document.body.style.overflow = 'auto';
    }
}

function adminLogin() {
    const password = document.getElementById('adminPassword').value;
    
    if (password === adminPassword) {
        // ç™»å…¥æˆåŠŸ
        document.getElementById('adminLogin').style.display = 'none';
        document.getElementById('ordersPanel').style.display = 'block';
        
        // è¼‰å…¥è¨‚å–®åˆ—è¡¨
        loadOrders();
    } else {
        alert('å¯†ç¢¼éŒ¯èª¤ï¼');
    }
}

function loadOrders(filter = 'all') {
    const ordersList = document.getElementById('ordersList');
    if (!ordersList) return;
    
    let filteredOrders = [...orders];
    
    // æ‡‰ç”¨ç¯©é¸å™¨
    if (filter !== 'all') {
        filteredOrders = orders.filter(order => order.status === filter);
    }
    
    // æ¸…ç©ºåˆ—è¡¨
    ordersList.innerHTML = '';
    
    // æŒ‰æ™‚é–“æ’åºï¼ˆæœ€æ–°çš„åœ¨æœ€ä¸Šé¢ï¼‰
    filteredOrders.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    
    // é¡¯ç¤ºè¨‚å–®
    filteredOrders.forEach(order => {
        const orderElement = document.createElement('div');
        orderElement.className = 'table-row';
        orderElement.dataset.orderId = order.id;
        
        const statusClass = `status-${order.status}`;
        const statusText = {
            'pending': 'å¾…è™•ç†',
            'paid': 'å·²ä»˜æ¬¾',
            'processing': 'è™•ç†ä¸­',
            'completed': 'å·²å®Œæˆ',
            'cancelled': 'å·²å–æ¶ˆ'
        }[order.status] || order.status;
        
        orderElement.innerHTML = `
            <div>${order.id}</div>
            <div>${order.service.name}<br><small style="color: #8a9ba8;">${order.service.description}</small></div>
            <div>
                ${order.customer.name}<br>
                <small style="color: #8a9ba8;">${order.customer.contact}</small>
            </div>
            <div>${new Date(order.createdAt).toLocaleDateString('zh-TW')}<br>
                <small style="color: #8a9ba8;">${new Date(order.createdAt).toLocaleTimeString('zh-TW', {hour: '2-digit', minute:'2-digit'})}</small>
            </div>
            <div style="color: #00ff9d; font-weight: bold;">
                ${order.service.price.toLocaleString()} TWD
            </div>
            <div>
                <span class="order-status ${statusClass}">${statusText}</span>
            </div>
            <div class="order-actions">
                <button class="action-btn view" onclick="viewOrder('${order.id}')">æŸ¥çœ‹</button>
                <button class="action-btn edit" onclick="editOrder('${order.id}')">ç·¨è¼¯</button>
                <button class="action-btn delete" onclick="deleteOrder('${order.id}')">åˆªé™¤</button>
            </div>
        `;
        
        ordersList.appendChild(orderElement);
    });
    
    // æ›´æ–°ç¯©é¸å™¨ç‹€æ…‹
    updateFilterButtons(filter);
}

function updateFilterButtons(activeFilter) {
    const filterButtons = document.querySelectorAll('.filter-btn');
    filterButtons.forEach(btn => {
        btn.classList.remove('active');
        if (btn.textContent.includes(activeFilter === 'all' ? 'å…¨éƒ¨è¨‚å–®' : 
            activeFilter === 'pending' ? 'å¾…è™•ç†' :
            activeFilter === 'paid' ? 'å·²ä»˜æ¬¾' :
            activeFilter === 'processing' ? 'è™•ç†ä¸­' :
            activeFilter === 'completed' ? 'å·²å®Œæˆ' : 'å·²å–æ¶ˆ')) {
            btn.classList.add('active');
        }
    });
}

function filterOrders(filterType) {
    loadOrders(filterType);
}

function refreshOrders() {
    loadOrders('all');
}

function viewOrder(orderId) {
    const order = orders.find(o => o.id === orderId);
    if (!order) return;
    
    const modal = document.getElementById('orderDetailModal');
    const content = modal.querySelector('.order-detail-grid');
    
    // è¨­å®šè¨‚å–®IDåˆ°æ¨¡æ…‹æ¡†
    modal.dataset.currentOrderId = orderId;
    
    // å¡«å……è¨‚å–®è©³æƒ…
    content.innerHTML = `
        <div class="detail-section">
            <h4>è¨‚å–®è³‡è¨Š</h4>
            <div class="detail-item">
                <span class="detail-label">è¨‚å–®ç·¨è™Ÿï¼š</span>
                <span class="detail-value">${order.id}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">æœå‹™é …ç›®ï¼š</span>
                <span class="detail-value">${order.service.name}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">æœå‹™å…§å®¹ï¼š</span>
                <span class="detail-value">${order.service.description}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">é‡‘é¡ï¼š</span>
                <span class="detail-value" style="color: #00ff9d;">${order.service.price.toLocaleString()} TWD</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">å»ºç«‹æ™‚é–“ï¼š</span>
                <span class="detail-value">${new Date(order.createdAt).toLocaleString('zh-TW')}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">æœ€å¾Œæ›´æ–°ï¼š</span>
                <span class="detail-value">${new Date(order.updatedAt).toLocaleString('zh-TW')}</span>
            </div>
        </div>
        
        <div class="detail-section">
            <h4>å®¢æˆ¶è³‡è¨Š</h4>
            <div class="detail-item">
                <span class="detail-label">å®¢æˆ¶å§“åï¼š</span>
                <span class="detail-value">${order.customer.name}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">è¯çµ¡æ–¹å¼ï¼š</span>
                <span class="detail-value">${order.customer.contact}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">éŠæˆ²IDï¼š</span>
                <span class="detail-value">${order.customer.gameId}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">å‚™è¨»ï¼š</span>
                <span class="detail-value">${order.customer.notes || 'ç„¡'}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">ä»˜æ¬¾æ–¹å¼ï¼š</span>
                <span class="detail-value">${order.payment.method || 'æœªé¸æ“‡'}</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">ä»˜æ¬¾ç‹€æ…‹ï¼š</span>
                <span class="detail-value">${order.payment.status === 'paid' ? 'å·²ä»˜æ¬¾' : 'å¾…ä»˜æ¬¾'}</span>
            </div>
        </div>
        
        ${order.assignedTo ? `
        <div class="detail-section">
            <h4>è™•ç†äººå“¡</h4>
            <div class="detail-item">
                <span class="detail-label">è² è²¬äººï¼š</span>
                <span class="detail-value">${order.assignedTo}</span>
            </div>
        </div>
        ` : ''}
        
        ${order.notes && order.notes.length > 0 ? `
        <div class="detail-section">
            <h4>è™•ç†å‚™è¨»</h4>
            ${order.notes.map(note => `
                <div class="detail-item">
                    <span class="detail-label">${new Date(note.time).toLocaleString('zh-TW', {month: 'short', day: 'numeric', hour: '2-digit', minute:'2-digit'})}</span>
                    <span class="detail-value">${note.text}</span>
                </div>
            `).join('')}
        </div>
        ` : ''}
    `;
    
    // é¡¯ç¤ºæ¨¡æ…‹æ¡†
    modal.classList.add('active');
}

function closeOrderDetail() {
    const modal = document.getElementById('orderDetailModal');
    modal.classList.remove('active');
}

function updateOrderStatus(status) {
    const orderId = document.getElementById('orderDetailModal').dataset.currentOrderId;
    const order = orders.find(o => o.id === orderId);
    
    if (order) {
        order.status = status;
        order.updatedAt = new Date().toISOString();
        
        // å¦‚æœæ˜¯è™•ç†ä¸­ç‹€æ…‹ï¼Œè‡ªå‹•åˆ†é…çµ¦ç•¶å‰ç®¡ç†å“¡
        if (status === 'processing' && !order.assignedTo) {
            order.assignedTo = 'ç•¶å‰ç®¡ç†å“¡';
        }
        
        // å„²å­˜æ›´æ–°
        saveOrdersToStorage();
        
        // æ›´æ–°è¨‚å–®åˆ—è¡¨
        loadOrders();
        
        // æ›´æ–°çµ±è¨ˆ
        updateOrderStats();
        
        // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
        alert(`è¨‚å–® ${orderId} å·²æ›´æ–°ç‚º ${getStatusText(status)}`);
        
        // é—œé–‰è©³æƒ…è¦–çª—
        closeOrderDetail();
    }
}

function getStatusText(status) {
    const statusMap = {
        'pending': 'å¾…è™•ç†',
        'paid': 'å·²ä»˜æ¬¾',
        'processing': 'è™•ç†ä¸­',
        'completed': 'å·²å®Œæˆ',
        'cancelled': 'å·²å–æ¶ˆ'
    };
    return statusMap[status] || status;
}

function assignToMe() {
    const orderId = document.getElementById('orderDetailModal').dataset.currentOrderId;
    const order = orders.find(o => o.id === orderId);
    
    if (order) {
        order.assignedTo = 'ç•¶å‰ç®¡ç†å“¡';
        order.updatedAt = new Date().toISOString();
        
        // è‡ªå‹•è¨­ç½®ç‚ºè™•ç†ä¸­ç‹€æ…‹
        order.status = 'processing';
        
        saveOrdersToStorage();
        loadOrders();
        updateOrderStats();
        
        alert(`æ‚¨å·²æ¥æ‰‹è¨‚å–® ${orderId}`);
        closeOrderDetail();
    }
}

function addOrderNote() {
    const noteText = prompt('è«‹è¼¸å…¥è™•ç†å‚™è¨»ï¼š');
    if (noteText) {
        const orderId = document.getElementById('orderDetailModal').dataset.currentOrderId;
        const order = orders.find(o => o.id === orderId);
        
        if (order) {
            if (!order.notes) {
                order.notes = [];
            }
            
            order.notes.push({
                text: noteText,
                time: new Date().toISOString(),
                author: 'ç®¡ç†å“¡'
            });
            
            order.updatedAt = new Date().toISOString();
            saveOrdersToStorage();
            
            // é‡æ–°è¼‰å…¥è¨‚å–®è©³æƒ…
            viewOrder(orderId);
            
            alert('å‚™è¨»å·²æ–°å¢');
        }
    }
}

function editOrder(orderId) {
    alert('ç·¨è¼¯åŠŸèƒ½é–‹ç™¼ä¸­...');
    // æœªä¾†å¯ä»¥å¯¦ä½œå®Œæ•´çš„è¨‚å–®ç·¨è¼¯åŠŸèƒ½
}

function deleteOrder(orderId) {
    if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è¨‚å–®å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
        orders = orders.filter(order => order.id !== orderId);
        saveOrdersToStorage();
        loadOrders();
        updateOrderStats();
        alert('è¨‚å–®å·²åˆªé™¤');
    }
}

function saveOrdersToStorage() {
    localStorage.setItem('delta_orders', JSON.stringify(orders));
}

function updateOrderStats() {
    // è¨ˆç®—çµ±è¨ˆæ•¸æ“š
    const totalOrders = orders.length;
    const pendingOrders = orders.filter(o => o.status === 'pending').length;
    const today = new Date().toDateString();
    const todayOrders = orders.filter(o => new Date(o.createdAt).toDateString() === today).length;
    const totalRevenue = orders.reduce((sum, order) => sum + order.service.price, 0);
    
    // æ›´æ–°é¡¯ç¤º
    document.getElementById('totalOrders').textContent = totalOrders;
    document.getElementById('pendingOrders').textContent = pendingOrders;
    document.getElementById('todayOrders').textContent = todayOrders;
    document.getElementById('totalRevenue').textContent = totalRevenue.toLocaleString();
}

// ============================
// è³‡æ–™åŒæ­¥åŠŸèƒ½
// ============================
function showSyncPanel() {
    document.getElementById('syncPanel').style.display = 'block';
}

function generateSyncCode() {
    const syncData = {
        orders: orders,
        timestamp: Date.now(),
        expires: Date.now() + (24 * 60 * 60 * 1000) // 24å°æ™‚æœ‰æ•ˆ
    };
    
    // å°‡è³‡æ–™è½‰æ›ç‚ºBase64ç·¨ç¢¼å­—ä¸²
    const jsonString = JSON.stringify(syncData);
    const syncCode = btoa(unescape(encodeURIComponent(jsonString)));
    
    document.getElementById('syncCodeDisplay').textContent = syncCode;
    document.getElementById('syncCodeDisplay').style.color = '#00ff9d';
    
    // è‡ªå‹•è¤‡è£½åˆ°å‰ªè²¼ç°¿
    navigator.clipboard.writeText(syncCode).then(() => {
        alert('åŒæ­¥ç¢¼å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼æ­¤åŒæ­¥ç¢¼24å°æ™‚å…§æœ‰æ•ˆã€‚');
    });
}

function importFromSyncCode() {
    const syncCode = document.getElementById('inputSyncCode').value.trim();
    
    if (!syncCode) {
        alert('è«‹è¼¸å…¥åŒæ­¥ç¢¼');
        return;
    }
    
    try {
        // è§£ç¢¼Base64å­—ä¸²
        const jsonString = decodeURIComponent(escape(atob(syncCode)));
        const syncData = JSON.parse(jsonString);
        
        // æª¢æŸ¥åŒæ­¥ç¢¼æ˜¯å¦éæœŸ
        if (Date.now() > syncData.expires) {
            alert('æ­¤åŒæ­¥ç¢¼å·²éæœŸï¼Œè«‹é‡æ–°ç”¢ç”Ÿæ–°çš„åŒæ­¥ç¢¼ã€‚');
            return;
        }
        
        // åˆä½µè¨‚å–®è³‡æ–™ï¼ˆé¿å…é‡è¤‡ï¼‰
        const existingOrderIds = new Set(orders.map(o => o.id));
        const newOrders = syncData.orders.filter(order => !existingOrderIds.has(order.id));
        
        // æ–°å¢è¨‚å–®
        orders = [...orders, ...newOrders];
        
        // å„²å­˜åˆ°æœ¬åœ°å„²å­˜
        saveOrdersToStorage();
        
        // æ›´æ–°é¡¯ç¤º
        loadOrders();
        updateOrderStats();
        
        alert(`æˆåŠŸåŒ¯å…¥ ${newOrders.length} ç­†æ–°è¨‚å–®ï¼`);
        document.getElementById('inputSyncCode').value = '';
        
    } catch (error) {
        alert('åŒæ­¥ç¢¼ç„¡æ•ˆæˆ–å·²ææ¯€ï¼Œè«‹æª¢æŸ¥å¾Œé‡è©¦ã€‚');
        console.error('åŒæ­¥éŒ¯èª¤:', error);
    }
}

// ============================
// ç³»çµ±è¨­å®šåŠŸèƒ½
// ============================
function changeAdminPassword() {
    const newPassword = document.getElementById('newAdminPassword').value.trim();
    
    if (!newPassword) {
        alert('è«‹è¼¸å…¥æ–°å¯†ç¢¼');
        return;
    }
    
    if (newPassword.length < 6) {
        alert('å¯†ç¢¼é•·åº¦è‡³å°‘6å€‹å­—å…ƒ');
        return;
    }
    
    adminPassword = newPassword;
    localStorage.setItem('admin_password', newPassword);
    
    alert('å¯†ç¢¼å·²æˆåŠŸè®Šæ›´ï¼');
    document.getElementById('newAdminPassword').value = '';
}

function saveNotificationSettings() {
    const enableNotifications = document.getElementById('enableNotifications').checked;
    localStorage.setItem('notifications_enabled', enableNotifications);
    alert('é€šçŸ¥è¨­å®šå·²å„²å­˜ï¼');
}

function backupData() {
    const backupData = {
        orders: orders,
        timestamp: new Date().toISOString(),
        version: '1.0'
    };
    
    const jsonString = JSON.stringify(backupData, null, 2);
    const blob = new Blob([jsonString], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `delta_backup_${Date.now()}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    alert('å‚™ä»½æª”æ¡ˆå·²é–‹å§‹ä¸‹è¼‰ï¼');
}

function clearOldOrders() {
    if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å·²å®Œæˆå’Œå·²å–æ¶ˆçš„è¨‚å–®å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
        orders = orders.filter(order => order.status === 'pending' || order.status === 'paid' || order.status === 'processing');
        saveOrdersToStorage();
        loadOrders();
        updateOrderStats();
        alert('èˆŠè¨‚å–®å·²æ¸…é™¤ï¼');
    }
}

function exportOrders() {
    const csvContent = [
        ['è¨‚å–®ç·¨è™Ÿ', 'æœå‹™é …ç›®', 'é‡‘é¡', 'å®¢æˆ¶å§“å', 'è¯çµ¡æ–¹å¼', 'éŠæˆ²ID', 'ç‹€æ…‹', 'å»ºç«‹æ™‚é–“', 'æ›´æ–°æ™‚é–“'].join(','),
        ...orders.map(order => [
            order.id,
            order.service.name,
            order.service.price,
            order.customer.name,
            order.customer.contact,
            order.customer.gameId,
            order.status,
            new Date(order.createdAt).toLocaleString('zh-TW'),
            new Date(order.updatedAt).toLocaleString('zh-TW')
        ].map(field => `"${field}"`).join(','))
    ].join('\n');
    
    const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `delta_orders_${Date.now()}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    alert('è¨‚å–®è³‡æ–™å·²åŒ¯å‡ºç‚ºCSVæª”æ¡ˆï¼');
}

// ============================
// é€šçŸ¥åŠŸèƒ½
// ============================
function sendNewOrderNotification(orderData) {
    // å„²å­˜æœ€å¾Œä¸€å€‹è¨‚å–®IDåˆ°æœ¬åœ°å„²å­˜
    localStorage.setItem('last_order_id', orderData.id);
    localStorage.setItem('new_order_notification', 'true');
}

function checkForNewOrders() {
    const notificationsEnabled = localStorage.getItem('notifications_enabled') !== 'false';
    const hasNewOrder = localStorage.getItem('new_order_notification') === 'true';
    
    if (notificationsEnabled && hasNewOrder) {
        const orderId = localStorage.getItem('last_order_id');
        showNotification(`æ–°è¨‚å–® ${orderId} å·²æäº¤ï¼Œè«‹åŠæ™‚è™•ç†ï¼`);
        
        // æ¸…é™¤é€šçŸ¥æ¨™è¨˜
        localStorage.removeItem('new_order_notification');
    }
}

function showNotification(message) {
    const notification = document.getElementById('orderNotification');
    const notificationText = document.getElementById('notificationText');
    
    if (notification && notificationText) {
        notificationText.textContent = message;
        notification.style.display = 'block';
        
        // 10ç§’å¾Œè‡ªå‹•éš±è—
        setTimeout(() => {
            closeNotification();
        }, 10000);
    }
}

function closeNotification() {
    const notification = document.getElementById('orderNotification');
    if (notification) {
        notification.style.display = 'none';
    }
}

// ============================
// è¯çµ¡è³‡è¨ŠåŠŸèƒ½
// ============================
function showContactInfo() {
    alert('è¯çµ¡è³‡è¨Šï¼š\n\nğŸ“± Line: delta_service\nğŸ“§ Email: delta@service.com\nğŸ•’ æœå‹™æ™‚é–“: 24å°æ™‚');
}

// ============================
// è¦å‰‡æ¢æ¬¾åŠŸèƒ½
// ============================
function showRules() {
    const rules = `
    âš ï¸ æœå‹™è¦å‰‡èˆ‡æ¢æ¬¾ï¼š
    
    1. æ‰€æœ‰æœå‹™éœ€é ç´„ä»˜æ¬¾å¾Œæ‰èƒ½é–‹å§‹
    2. è­·èˆªæœå‹™ä¿è­‰é‡‘é¡ï¼Œå¤±æ•—æœ‰è£œå„Ÿæ©Ÿåˆ¶
    3. è³­ç´„å–®é¢¨éšªè‡ªè² ï¼Œä¸‹å–®å¾Œä¸å¯åæ‚”
    4. é™ªç©æœå‹™ä¸ä¿è­‰æ“Šæ®ºæ•¸ï¼ˆä¸åŒ…å¾—åƒï¼‰
    5. å–æ¶ˆè¨‚å–®éœ€æå‰3å°æ™‚é€šçŸ¥
    6. æƒ¡æ„è¡Œç‚ºå°‡è¢«åˆ—å…¥é»‘åå–®
    
    è©³ç´°è¦å‰‡è«‹åƒè€ƒå®˜æ–¹ç¤¾ç¾¤å…¬å‘Šã€‚
    `;
    
    alert(rules);
}

// åˆå§‹åŒ–æ™‚æª¢æŸ¥é€šçŸ¥è¨­å®š
const notificationsEnabled = localStorage.getItem('notifications_enabled');
if (notificationsEnabled === null) {
    localStorage.setItem('notifications_enabled', 'true');
}

// è¦å‰‡æ¢æ¬¾é é¢åˆå§‹åŒ–
document.getElementById('rules').innerHTML = `
    <div class="payment-section">
        <h2 style="color: #ff6600; margin-bottom: 30px; text-align: center;">æœå‹™è¦å‰‡èˆ‡æ¢æ¬¾</h2>
        
        <div style="background: rgba(255, 102, 0, 0.1); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
            <h3 style="color: #ffcc00;">ğŸ“‹ åŸºæœ¬è¦å‰‡</h3>
            <ul style="color: #8a9ba8; margin-top: 10px; padding-left: 20px;">
                <li>æ‰€æœ‰æœå‹™éœ€é ç´„ä»˜æ¬¾å¾Œæ‰èƒ½é–‹å§‹</li>
                <li>è­·èˆªæœå‹™ä¿è­‰é‡‘é¡ï¼Œå¤±æ•—æœ‰è£œå„Ÿæ©Ÿåˆ¶</li>
                <li>å–æ¶ˆè¨‚å–®éœ€æå‰3å°æ™‚é€šçŸ¥</li>
                <li>æƒ¡æ„è¡Œç‚ºå°‡è¢«åˆ—å…¥é»‘åå–®</li>
            </ul>
        </div>
        
        <div style="background: rgba(0, 150, 255, 0.1); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
            <h3 style="color: #66b3ff;">âš¡ è­·èˆªæœå‹™è¦å‰‡</h3>
            <ul style="color: #8a9ba8; margin-top: 10px; padding-left: 20px;">
                <li>åŸºç¤å–®ï¼šç‚¸å–®è£œå„Ÿ +100w (ä¸Šé™1000w)</li>
                <li>é«”é©—å–®ï¼šé©ç”¨æ–¼æ–°å®¢æˆ¶è©¦ç”¨</li>
                <li>èˆªå¤©è³­ç´„å–®ï¼šé«˜é¢¨éšªé«˜å›å ±</li>
                <li>æœå‹™æ™‚é–“ï¼š24å°æ™‚</li>
            </ul>
        </div>
        
        <div style="background: rgba(255, 102, 182, 0.1); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
            <h3 style="color: #ff66b2;">ğŸ® é™ªç©æœå‹™è¦å‰‡</h3>
            <ul style="color: #8a9ba8; margin-top: 10px; padding-left: 20px;">
                <li>ä¸ä¿è­‰æ“Šæ®ºæ•¸ï¼ˆä¸åŒ…å¾—åƒï¼‰</li>
                <li>æ™‚é•·å¥—é¤äº«æœ‰å„ªæƒ </li>
                <li>æ–°å®¢æˆ¶å°ˆå±¬ç¦åˆ©</li>
                <li>ç”·å¥³é™ªç©å¸«å¯é¸</li>
            </ul>
        </div>
        
        <div style="background: rgba(255, 204, 0, 0.1); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
            <h3 style="color: #ffcc00;">âš ï¸ æ³¨æ„äº‹é …</h3>
            <ul style="color: #8a9ba8; margin-top: 10px; padding-left: 20px;">
                <li>è³­ç´„å…§å®¹åŠæ¢ç´„ä¸å¯æ›´å‹•åŠè€è³´</li>
                <li>ä¸‹è¨‚å¾Œä¸å¯åæ‚”æˆ–æ•…æ„å¡ä¿åº•</li>
                <li>ç©çš„å°±æ˜¯å¿ƒè·³ï¼Œå¾—å¤±å¿ƒé‡è€…å‹¿ä¸‹å–®</li>
                <li>ç™¼ç¾é•è¦ç›´æ¥çµå–®</li>
            </ul>
        </div>
        
        <div style="text-align: center; margin-top: 30px;">
            <button class="btn" onclick="showTab('home')">è¿”å›é¦–é </button>
        </div>
    </div>
`;

// è¯çµ¡å€åˆå§‹åŒ–
document.querySelector('.contact-section').innerHTML = `
    <h2 class="contact-title">ğŸ“ è¯çµ¡æˆ‘å€‘</h2>
    <div class="contact-info">Line: delta_service</div>
    <div class="contact-info">æœå‹™æ™‚é–“: 24å°æ™‚</div>
    <div class="contact-info">ç·Šæ€¥è¯çµ¡: +886 987-654-321</div>
    
    <div style="margin-top: 30px;">
        <p style="color: #8a9ba8; margin-bottom: 20px;">
            æœ‰ä»»ä½•å•é¡Œæˆ–ç‰¹æ®Šéœ€æ±‚ï¼Œè«‹éš¨æ™‚è¯ç¹«æˆ‘å€‘ï¼<br>
            æˆ‘å€‘çš„å®¢æœåœ˜éšŠå°‡åœ¨ç¬¬ä¸€æ™‚é–“ç‚ºæ‚¨æœå‹™ã€‚
        </p>
        <button class="btn btn-secondary" onclick="showContactInfo()">æŸ¥çœ‹æ›´å¤šè¯çµ¡æ–¹å¼</button>
    </div>
`;

// é è…³æ›´æ–°å¹´ä»½
document.querySelector('.footer').innerHTML = `
    <p>ä¸‰è§’æ´²è¡Œå‹• Â· å°ˆæ¥­æˆ°è¡“æ”¯æ´æœå‹™</p>
    <p>Â© ${new Date().getFullYear()} Delta Operations. All rights reserved.</p>
    <p style="margin-top: 10px; font-size: 0.8rem; color: #666;">
        æœ¬ç¶²ç«™åƒ…ä¾›å¨›æ¨‚ä½¿ç”¨ Â· æœå‹™è¦å‰‡å¦‚æœ‰è®Šæ›´æ•ä¸å¦è¡Œé€šçŸ¥
    </p>
`;

console.log('ä¸‰è§’æ´²è¡Œå‹•ç¶²ç«™å·²æˆåŠŸè¼‰å…¥ï¼');
</script>
</body>
</html>